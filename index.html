<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>weCare</title>
  
  <style>
    :root {
      --bg-color: #1e1e2f;
      --input-bg: #2a2a3d;
      --text-color: #f0f0f0;
      --accent-color: #4e9eff;
      --secondary-color: #888;
    }

    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 2rem;
      min-height: 100vh;
      margin: 0;
    }

    h1 {
      font-size: 5rem;
      margin-bottom: 1.5rem;
      color: var(--accent-color);
      text-align: center;
      transition: transform 0.5s ease, opacity 0.5s ease;
    }

    @keyframes titlePulse {
      0% {
        transform: scale(1);
        opacity: 0.5;
      }
      50% {
        transform: scale(1.05);
        opacity: 1;
      }
      100% {
        transform: scale(1);
        opacity: 0.5;
      }
    }

    h1.pulsing {
      animation: titlePulse 1.5s infinite;
    }

    .chat-container {
      width: 100%;
      max-width: 700px;
      background: rgba(0,0,0,0);
      border-radius: 22px;
      padding: 20px;
    }

    #response {
      white-space: pre-wrap;
      padding: 15px;
      background: rgba(0,0,0,0);
      border-radius: 22px;
      margin-top: 1rem;
      min-height: 100px;
      color: var(--text-color);
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .user-message {
      align-self: flex-end;
      background-color: var(--accent-color);
      padding: 10px 15px;
      border-radius: 18px 18px 0 18px;
      max-width: 80%;
      word-break: break-word;
    }
    
    .assistant-message {
      align-self: flex-start;
      background-color: var(--input-bg);
      padding: 10px 15px;
      border-radius: 18px 18px 18px 0;
      max-width: 80%;
      word-break: break-word;
    }

    .input-section {
      display: flex;
      gap: 10px;
      margin-top: 1rem;
    }

    input[type="text"] {
      flex: 1;
      padding: 12px;
      font-size: 1rem;
      border-radius: 22px;
      border: none;
      background: var(--input-bg);
      color: var(--text-color);
    }

    .mic-button {
      padding: 12px 16px;
      font-size: 1rem;
      border: none;
      border-radius: 22px;
      background: transparent;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0.4;
      transition: opacity 0.3s ease;
    }

    .mic-button:hover {
      opacity: 0.8;
    }

    .mic-button svg {
      height: 20px;
      fill: white;
    }

    @keyframes pulse {
      0% {
        transform: scale(1);
        opacity: 0.8;
      }
      50% {
        transform: scale(1.2);
        opacity: 1;
      }
      100% {
        transform: scale(1);
        opacity: 0.8;
      }
    }

    .mic-button.pulsing {
      animation: pulse 1s infinite;
    }

    @media (max-width: 600px) {
      .input-section {
        flex-direction: column;
      }

      .mic-button {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <h1 id="titleElement">weCare</h1>

  <div class="chat-container">
    <div class="input-section">
      <input type="text" id="userInput" placeholder=" Type your message..." />
      <button class="mic-button" onclick="startListening()">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512">
          <path d="M192 0C139 0 96 43 96 96l0 160c0 53 43 96 96 96s96-43 96-96l0-160c0-53-43-96-96-96zM64 216c0-13.3-10.7-24-24-24s-24 10.7-24 24l0 40c0 89.1 66.2 162.7 152 174.4l0 33.6-48 0c-13.3 0-24 10.7-24 24s10.7 24 24 24l72 0 72 0c13.3 0 24-10.7 24-24s-10.7-24-24-24l-48 0 0-33.6c85.8-11.7 152-85.3 152-174.4l0-40c0-13.3-10.7-24-24-24s-24 10.7-24 24l0 40c0 70.7-57.3 128-128 128s-128-57.3-128-128l0-40z"/>
        </svg>
      </button>
    </div>
    <div id="response"> . . . </div>
  </div>

  <script>
    const apiKey = 'AIzaSyAi-GeDx3FFqvkUPuKxFKdOMv8RLUetuDQ';
    const titleElement = document.getElementById('titleElement');
    
    let conversationHistory = [];
    
    const preprompt = "You are Cindy, a caring healthcare worker who is trying to diagnose the user and help them get in touch with the right healthcare professional. Be empathetic and provide simple and concise suggestions based on the symptoms or issues they mention. If the request is not health related then remind them this is a helpline for people with mental and physical ailments. (Never mention that you are an ai) ";
    
    function startTitlePulsing() {
      titleElement.classList.add('pulsing');
    }

    function stopTitlePulsing() {
      titleElement.classList.remove('pulsing');
    }
    
    function buildConversationPayload(newMessage) {
      const historyMessages = conversationHistory.map(message => ({
        role: message.role,
        parts: [{ text: message.text }]
      }));
      
      return {
        contents: [
          { role: "user", parts: [{ text: preprompt }] },
          ...historyMessages,
          { role: "user", parts: [{ text: newMessage }] }
        ]
      };
    }
    
    function appendToConversationDisplay(role, message) {
      const responseDiv = document.getElementById('response');
      const messageElement = document.createElement('div');
      messageElement.classList.add(role === 'user' ? 'user-message' : 'assistant-message');
      
      if (role === 'user') {
        responseDiv.innerHTML = '';
        responseDiv.appendChild(messageElement);
        messageElement.textContent = message;
      } else {
        responseDiv.textContent = '';
        typeWriter(message, responseDiv);
      }
    }

    async function sendToGemini() {
      const input = document.getElementById('userInput').value;
      const responseDiv = document.getElementById('response');
      if (!input.trim()) return;
      
      document.getElementById('userInput').value = '';
      
      conversationHistory.push({ role: "user", text: input });
      appendToConversationDisplay('user', input);
      
      responseDiv.textContent = '. . .';
      startTitlePulsing();

      try {
        const res = await fetch(
          `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`,
          {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(buildConversationPayload(input))
          }
        );

        const data = await res.json();
        const result = data?.candidates?.[0]?.content?.parts?.[0]?.text || 'No response';
        
        conversationHistory.push({ role: "model", text: result });
        responseDiv.textContent = '';
        stopTitlePulsing();
        typeWriter(result, responseDiv);

      } catch (err) {
        console.error(err);
        responseDiv.textContent = 'Error: Could not reach Gemini API.';
        stopTitlePulsing();
      }
    }

    function typeWriter(text, element, i = 0, speed = 22) {
      if (i < text.length) {
        element.textContent += text.charAt(i);
        i++;
        setTimeout(() => typeWriter(text, element, i, speed), speed);
      }
    }

    function startListening() {
      const micButton = document.querySelector('.mic-button');
      const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
      recognition.lang = 'en-US';
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;

      micButton.classList.add('pulsing');
      
      recognition.onresult = event => {
        const transcript = event.results[0][0].transcript;
        document.getElementById('userInput').value = transcript;
        sendToGemini();
        micButton.classList.remove('pulsing');
      };

      recognition.onerror = event => {
        alert('Speech recognition error: ' + event.error);
        micButton.classList.remove('pulsing');
      };

      recognition.onend = () => {
        micButton.classList.remove('pulsing');
      };

      recognition.start();
    }

    document.getElementById('userInput').addEventListener('keydown', function(event) {
      if (event.key === 'Enter') {
        sendToGemini();
      }
    });

    history.pushState(null, "", "/wecare.health");

  </script>
</body>
</html>
